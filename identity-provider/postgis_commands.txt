# PostGIS installation & DB setup commands (PowerShell safe)

# 1) (Optionnel) Backup de la base (exécuter localement)
# Exporte la base auth_db vers ./backup_auth_db.sql
docker exec -i auth_postgres pg_dump -U auth auth_db > ./backup_auth_db.sql

# 2) Installer PostGIS dans le conteneur (ligne unique sûre)
docker exec -it auth_postgres bash -lc "apt-get update && apt-get install -y postgis postgresql-15-postgis-3 postgresql-contrib"

# (Alternative en deux étapes si tu veux éviter la chaîne &&)
docker exec -it auth_postgres bash -lc "apt-get update"
docker exec -it auth_postgres bash -lc "apt-get install -y postgis postgresql-15-postgis-3 postgresql-contrib"

# 3) Redémarrer PostgreSQL (après l'installation)
docker restart auth_postgres

# 4) Activer les extensions dans la base
# (exécuter après redémarrage)
docker exec -it auth_postgres psql -U auth -d auth_db -c "CREATE EXTENSION IF NOT EXISTS postgis;"
docker exec -it auth_postgres psql -U auth -d auth_db -c "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";"

# 5) Vérifier que PostGIS est disponible
docker exec -it auth_postgres psql -U auth -d auth_db -c "SELECT PostGIS_full_version();"
docker exec -it auth_postgres psql -U auth -d auth_db -c "\dx"

# 6) Si le script base.sql a échoué partiellement — supprimer les tables problématiques et relancer
# ATTENTION : ceci supprime les tables et leurs données
docker exec -it auth_postgres psql -U auth -d auth_db -c "DROP TABLE IF EXISTS signalements, sessions, historique_statuts CASCADE;"
docker exec -it auth_postgres psql -U auth -d auth_db -f /docker-entrypoint-initdb.d/base.sql

# Notes
# - Les commandes sont à lancer depuis PowerShell. Les commandes docker exec contiennent une commande bash -lc pour permettre l'utilisation de && dans un seul appel.
# - L'installation télécharge des paquets dans le conteneur; ce n'est pas aussi lourd que re-puller une image complète mais nécessite un peu de bande passante.
# - Si tu veux, je peux exécuter ces commandes pour toi et te montrer la sortie.
